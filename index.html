<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ScanBot — выбор углов</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    html,body{height:100%;margin:0;background:#000;color:#eee;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    #wrap{height:100%;display:flex;flex-direction:column}
    #stage{flex:1;display:flex;align-items:center;justify-content:center;background:#000;position:relative}
    #msg{position:absolute;inset:auto 12px 12px 12px;background:rgba(0,0,0,.6);padding:10px 12px;border-radius:10px;border:1px solid #222;font-size:14px}
    canvas{max-width:100%;max-height:100%;touch-action:none;display:block}
    #bar{padding:12px;display:flex;gap:8px;border-top:1px solid #222;background:#111}
    button{padding:10px 14px;border:0;border-radius:10px;background:#2563eb;color:#fff;font-weight:600}
    .ghost{background:#333}
    .hint{margin-left:auto;opacity:.7;font-size:13px}
  </style>
</head>
<body>
<div id="wrap">
  <div id="stage">
    <canvas id="c"></canvas>
    <div id="msg" hidden></div>
  </div>
  <div id="bar">
    <button id="reset" class="ghost">Сброс</button>
    <button id="send">✅ Отправить</button>
    <div class="hint">Кликните 4 угла: ↖ ↗ ↘ ↙</div>
  </div>
</div>

<script>
const tg = window.Telegram.WebApp; tg.expand();

const urlParams = new URLSearchParams(location.search);
const fileId = urlParams.get("file_id"); // бот передаёт сюда file_id

// Новый код для загрузки изображения с использованием file_id
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const msg = document.getElementById('msg');
const pointsVis = [];     // точки в координатах canvas
const pointsSrc = [];     // точки в координатах исходного изображения

const img = new Image();
img.crossOrigin = "anonymous"; // на случай CORS
let fit = { x:0, y:0, w:0, h:0 };   // прямоугольник вписывания изображения в canvas
let dpr = window.devicePixelRatio || 1;

// Функция для отображения сообщений
function showMsg(text){ msg.textContent = text; msg.hidden = false; }
function hideMsg(){ msg.hidden = true; }

// Функция для изменения размера канваса
function resizeCanvas() {
  const rect = canvas.parentElement.getBoundingClientRect();
  const cssW = Math.max(320, Math.floor(rect.width));
  const cssH = Math.max(320, Math.floor(rect.height));
  dpr = window.devicePixelRatio || 1;
  canvas.style.width = cssW + "px";
  canvas.style.height = cssH + "px";
  canvas.width = Math.floor(cssW * dpr);
  canvas.height = Math.floor(cssH * dpr);
  layoutImage();
  draw();
}

// Функция для расположения изображения
function layoutImage() {
  if (!img.naturalWidth || !img.naturalHeight) { fit = {x:0,y:0,w:0,h:0}; return; }
  const cw = canvas.width, ch = canvas.height;
  const ir = img.naturalWidth / img.naturalHeight;
  const cr = cw / ch;
  let w,h;
  if (ir > cr) { w = cw; h = Math.round(cw / ir); }
  else { h = ch; w = Math.round(ch * ir); }
  const x = Math.round((cw - w) / 2);
  const y = Math.round((ch - h) / 2);
  fit = { x, y, w, h };
}

// Функция рисования
function draw() {
  // фон
  ctx.fillStyle = '#000';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  // изображение
  if (fit.w>0 && fit.h>0) ctx.drawImage(img, fit.x, fit.y, fit.w, fit.h);
  // полигоны/точки
  ctx.lineWidth = 2 * dpr;
  ctx.strokeStyle = '#00ff88';
  ctx.fillStyle = '#00ff88';
  if (pointsVis.length) {
    ctx.beginPath();
    pointsVis.forEach((p,i)=>{ if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y); });
    if (pointsVis.length===4) ctx.closePath();
    ctx.stroke();
    ctx.font = `${14*dpr}px sans-serif`;
    pointsVis.forEach((p,i)=>{ ctx.beginPath(); ctx.arc(p.x,p.y,5*dpr,0,Math.PI*2); ctx.fill();
      ctx.fillText(String(i+1), p.x+6*dpr, p.y-6*dpr);
    });
  }
}

// Загрузка изображения с использованием file_id
if (fileId) {
  showMsg('Загружаем изображение…');
  fetch(`https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getFile?file_id=${fileId}`)
    .then(response => response.json())
    .then(data => {
      if (data.ok) {
        const filePath = `https://api.telegram.org/file/bot<YOUR_BOT_TOKEN>/${data.result.file_path}`;
        img.onload = ()=>{ hideMsg(); layoutImage(); draw(); };
        img.onerror = ()=>{ showMsg('Не удалось загрузить изображение.'); draw(); };
        img.src = filePath;
      } else {
        showMsg('Не удалось загрузить изображение'); draw();
      }
    });
} else {
  showMsg('Превью не передано. Вернитесь и откройте редактор из бота, чтобы увидеть исходник.');
}

resizeCanvas();
</script>
</body>
</html>
